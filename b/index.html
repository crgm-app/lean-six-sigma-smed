<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMED Six Sigma - Velas y Pareto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root { --int: #007bff; --ext: #28a745; --nva: #dc3545; --dark: #1c1e21; --accent: #e67e22; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        
        .header { background: var(--dark); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 20px; border-bottom: 6px solid var(--accent); }
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        @media (min-width: 768px) { .controls { flex-direction: row; justify-content: center; } }
        
        select, input[type="file"] { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; cursor: pointer; }
        
        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-top: 12px solid; }
        .border-INT { border-color: var(--int); } .border-EXT { border-color: var(--ext); } .border-NVA { border-color: var(--nva); }

        .chart-row { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 1100px) { .chart-row { grid-template-columns: 1fr 1fr; } }
        
        .chart-box { height: 400px; background: #fafafa; border-radius: 10px; padding: 10px; }
        .table-wrapper { overflow-x: auto; margin-top: 15px; border-radius: 10px; border: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; font-size: 10px; min-width: 900px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; text-transform: uppercase; font-size: 9px; }
        td { padding: 10px; border: 1px solid #eee; text-align: center; }
        
        .gold { background: #fff9c4; font-weight: bold; }
        .acum-col { color: var(--accent); font-weight: bold; background: #fff5eb; border-left: 2px solid var(--accent) !important; }
        .sigma-badge { padding: 4px 8px; border-radius: 5px; color: white; font-weight: bold; font-size: 10px; }
        .badge { padding: 6px 15px; background: #eee; border-radius: 25px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0;">SMED Six Sigma <span style="color:var(--accent)">100&rarr;0 + Velas</span></h1>
    <p style="opacity:0.8;">Análisis de Dispersión y Pareto para Corrugadoras e Imprentas</p>
</div>

<div class="controls">
    <input type="file" id="csvFile" accept=".csv">
    <select id="selTurno">
        <option value="ALL">TODOS LOS TURNOS</option>
        <option value="T1">TURNO 1</option><option value="T2">TURNO 2</option><option value="T3">TURNO 3</option>
    </select>
    <select id="selColor">
        <option value="ALL">TODAS LAS COMPLEJIDADES</option>
        <option value="1">1 COLOR</option><option value="2">2 COLORES</option>
        <option value="3">3 COLORES</option><option value="4">4 COLORES</option>
    </select>
    <div id="status" style="font-weight:bold;">Cargue el archivo...</div>
</div>

<div id="dashboard" class="grid"></div>

<script>
    let globalData = [];
    let chartJS_Instances = [];

    document.getElementById('csvFile').addEventListener('change', function(e) {
        Papa.parse(e.target.files[0], {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            beforeFirstChunk: chunk => {
                let rows = chunk.split(/\r\n|\r|\n/);
                if (rows[0].startsWith("#")) rows.shift();
                return rows.join("\n");
            },
            complete: r => {
                globalData = r.data;
                document.getElementById('status').innerText = "✓ " + globalData.length + " Mediciones";
                render();
            }
        });
    });

    function render() {
        const tF = document.getElementById('selTurno').value;
        const cF = document.getElementById('selColor').value;
        const dash = document.getElementById('dashboard');
        dash.innerHTML = '';
        chartJS_Instances.forEach(c => c.destroy());
        chartJS_Instances = [];

        if (globalData.length === 0) return;

        const filtered = globalData.filter(d => {
            const matchT = (tF === 'ALL' || d.Turno === tF);
            const matchC = (cF === 'ALL' || Math.floor(d.Colores).toString() === cF);
            return matchT && matchC && d.Tipo && d.Actividad;
        });

        ['INT', 'EXT', 'NVA'].forEach(tipo => {
            const sub = filtered.filter(d => d.Tipo === tipo);
            if (sub.length === 0) return;
            const stats = processStats(sub);
            dash.appendChild(createCard(tipo, stats, tF, cF, sub));
        });
    }

    function processStats(data) {
        const catTotal = data.reduce((a, b) => a + (b.DuracionSeg || 0), 0);
        const groups = {};
        data.forEach(d => {
            if (!groups[d.Actividad]) groups[d.Actividad] = [];
            groups[d.Actividad].push(d.DuracionSeg);
        });

        let items = Object.keys(groups).map(name => {
            const v = groups[name].sort((a,b) => a-b);
            const n = v.length;
            const sum = v.reduce((a,b) => a+b, 0);
            const avg = sum/n;
            const std = Math.sqrt(v.map(x=>Math.pow(x-avg,2)).reduce((a,b)=>a+b,0)/(n-1)) || 0;
            return {
                name, total: sum, n, min: v[0], 
                q1: v[Math.floor(n*0.25)], med: v[Math.floor(n*0.5)], q3: v[Math.floor(n*0.75)],
                max: v[n-1], cv: avg > 0 ? (std/avg) : 0, pct: (sum / catTotal) * 100
            };
        }).sort((a,b) => b.total - a.total);

        let current = 100;
        items.forEach(i => { i.val100to0 = current; current -= i.pct; });
        return { items, catTotal };
    }

    function createCard(tipo, stats, tL, cL, rawSubData) {
        const card = document.createElement('div');
        card.className = `card border-${tipo}`;
        const color = tipo === 'INT' ? '#007bff' : tipo === 'EXT' ? '#28a745' : '#dc3545';
        const idBase = `chart_${tipo}_${Date.now()}`;
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">${tipo} | ${tL} | ${cL} Col</h2>
                <span class="badge">Total: ${(stats.catTotal/3600).toFixed(1)}h</span>
            </div>
            <div class="chart-row">
                <div class="chart-box"><canvas id="pareto_${idBase}"></canvas></div>
                <div class="chart-box" id="box_${idBase}"></div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Actividad</th><th colspan="5">Cuartiles (Segundos)</th><th colspan="2">Pareto</th><th colspan="2">Six Sigma</th>
                        </tr>
                        <tr>
                            <th>Min</th><th class="gold">Q1 (Meta)</th><th>Med</th><th>Q3</th><th>Max</th>
                            <th>Individual</th><th class="acum-col">100-0</th><th>σ</th><th>CV%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.items.map(i => `
                            <tr>
                                <td style="text-align:left"><b>${i.name}</b></td>
                                <td>${i.min}s</td><td class="gold">${i.q1}s</td><td>${i.med}s</td><td>${i.q3}s</td><td>${i.max}s</td>
                                <td>${i.pct.toFixed(1)}%</td><td class="acum-col">${i.val100to0.toFixed(1)}%</td>
                                <td>±${(i.cv * i.med).toFixed(0)}s</td>
                                <td><span class="sigma-badge" style="background:${i.cv < 0.4 ? '#28a745' : '#dc3545'}">${(i.cv*100).toFixed(0)}%</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        // Gráfico Pareto 100-0 (Chart.js)
        setTimeout(() => {
            const ctx = document.getElementById(`pareto_${idBase}`).getContext('2d');
            chartJS_Instances.push(new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.items.slice(0,8).map(i => i.name),
                    datasets: [
                        { label: 'Segundos', data: stats.items.slice(0,8).map(i => i.total), backgroundColor: color, yAxisID: 'y' },
                        { label: '% 100-0', data: stats.items.slice(0,8).map(i => i.val100to0), type: 'line', borderColor: '#e67e22', yAxisID: 'y1', tension: 0.2 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left' }, y1: { position: 'right', max: 100, min: 0 } } }
            }));

            // Gráfico de Velas (Plotly.js)
            const boxData = stats.items.slice(0,8).map(item => {
                return {
                    y: rawSubData.filter(d => d.Actividad === item.name).map(d => d.DuracionSeg),
                    type: 'box',
                    name: item.name,
                    marker: { color: color },
                    boxpoints: 'suspectedoutliers'
                };
            });
            Plotly.newPlot(`box_${idBase}`, boxData, { 
                title: 'Dispersión (Velas)', margin: { t: 40, b: 80, l: 50, r: 10 },
                showlegend: false, font: { size: 10 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
            }, {responsive: true});
        }, 100);

        return card;
    }

    document.getElementById('selTurno').addEventListener('change', render);
    document.getElementById('selColor').addEventListener('change', render);
</script>
</body>
</html>
