<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SMED Global Dashboard - crgm.app</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --int: #007bff; --ext: #28a745; --nva: #dc3545; --dark: #1c1e21; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; font-size: 11px; }
        .header { background: var(--dark); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; align-items: center; flex-wrap: wrap; }
        select, input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.1em; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); gap: 30px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-top: 8px solid; }
        .border-INT { border-color: var(--int); } .border-EXT { border-color: var(--ext); } .border-NVA { border-color: var(--nva); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 8px; border: 1px solid #dee2e6; font-size: 9px; }
        td { padding: 8px; border: 1px solid #eee; text-align: center; }
        .gold { background: #fff9c4; font-weight: bold; color: #856404; }
        .pct-col { color: #666; font-weight: bold; width: 45px; }
        .acum-col { color: var(--int); font-weight: bold; width: 55px; }
        .sigma-tag { padding: 3px 6px; border-radius: 4px; color: white; font-weight: bold; font-size: 9px; }
        .chart-box { height: 250px; margin-bottom: 15px; }
        .summary-badge { padding: 5px 15px; background: #e9ecef; border-radius: 20px; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h1>SMED Intelligence Global Explorer</h1>
    <p>Agregación Multidimensional: Turnos, Colores y Categorías Lean Six Sigma</p>
</div>

<div class="controls">
    <strong>1. Cargar Mediciones (CSV):</strong> <input type="file" id="csvFile" accept=".csv">
    <strong>2. Turno:</strong> 
    <select id="selTurno">
        <option value="ALL">TODOS LOS TURNOS</option>
        <option value="T1">Turno 1</option>
        <option value="T2">Turno 2</option>
        <option value="T3">Turno 3</option>
    </select>
    <strong>3. Complejidad:</strong> 
    <select id="selColor">
        <option value="ALL">TODOS LOS COLORES</option>
        <option value="1">1 Color</option>
        <option value="2">2 Colores</option>
        <option value="3">3 Colores</option>
        <option value="4">4 Colores</option>
    </select>
    <div id="status" style="font-weight:bold; color:var(--int)">Esperando CSV...</div>
</div>

<div id="dashboard" class="grid"></div>

<script>
    let rawDataGlobal = [];
    let charts = [];

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        document.getElementById('status').innerText = "Analizando 1,912 filas...";

        Papa.parse(file, {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            beforeFirstChunk: chunk => {
                let rows = chunk.split(/\r\n|\r|\n/);
                if (rows[0].startsWith("#")) rows.shift();
                return rows.join("\n");
            },
            complete: results => {
                rawDataGlobal = results.data;
                document.getElementById('status').innerText = "✓ Sistema Listo";
                updateUI();
            }
        });
    });

    function updateUI() {
        const tFilter = document.getElementById('selTurno').value;
        const cFilter = document.getElementById('selColor').value;
        const dash = document.getElementById('dashboard');
        dash.innerHTML = '';
        charts.forEach(c => c.destroy());
        charts = [];

        if (rawDataGlobal.length === 0) return;

        // Filtrado Dinámico
        const filtered = rawDataGlobal.filter(d => {
            const matchT = (tFilter === 'ALL' || d.Turno === tFilter);
            const matchC = (cFilter === 'ALL' || Math.floor(d.Colores).toString() === cFilter);
            return matchT && matchC && d.Tipo && d.Actividad;
        });

        if (filtered.length === 0) {
            dash.innerHTML = `<h2 style="grid-column: 1/-1; text-align: center;">No hay datos para esta combinación.</h2>`;
            return;
        }

        ['INT', 'EXT', 'NVA'].forEach(tipo => {
            const subData = filtered.filter(d => d.Tipo === tipo);
            if (subData.length === 0) return;

            const stats = processDeepStats(subData);
            dash.appendChild(renderCard(tipo, stats, tFilter, cFilter));
        });
    }

    function processDeepStats(data) {
        const catTotal = data.reduce((a, b) => a + (b.DuracionSeg || 0), 0);
        const grouped = {};
        
        data.forEach(d => {
            if (!grouped[d.Actividad]) grouped[d.Actividad] = [];
            grouped[d.Actividad].push(d.DuracionSeg);
        });

        let stats = Object.keys(grouped).map(name => {
            const v = grouped[name].sort((a,b) => a - b);
            const n = v.length;
            const sum = v.reduce((a,b) => a+b, 0);
            const avg = sum/n;
            const std = Math.sqrt(v.map(x=>Math.pow(x-avg,2)).reduce((a,b)=>a+b,0)/(n-1)) || 0;
            return {
                name, total: sum, n, min: v[0], 
                q1: v[Math.floor(n*0.25)], med: v[Math.floor(n*0.5)], 
                q3: v[Math.floor(n*0.75)], max: v[n-1],
                cv: avg > 0 ? (std/avg) : 0, pct: (sum/catTotal)*100
            };
        }).sort((a,b) => b.total - a.total);

        let runningPct = 0;
        stats.forEach(s => {
            runningPct += s.pct;
            s.acum = runningPct;
        });

        return { items: stats, totalSeg: catTotal };
    }

    function renderCard(tipo, data, tLab, cLab) {
        const card = document.createElement('div');
        card.className = `card border-${tipo}`;
        const color = tipo === 'INT' ? '#007bff' : tipo === 'EXT' ? '#28a745' : '#dc3545';
        
        const rows = data.items.slice(0, 10).map(s => `
            <tr>
                <td style="text-align:left"><b>${s.name}</b></td>
                <td>${s.min}s</td>
                <td class="gold">${s.q1}s</td>
                <td>${s.med}s</td>
                <td class="pct-col">${s.pct.toFixed(1)}%</td>
                <td class="acum-col">${s.acum.toFixed(1)}%</td>
                <td><span class="sigma-tag" style="background:${s.cv < 0.4 ? '#28a745' : '#dc3545'}">${(s.cv*100).toFixed(0)}%</span></td>
            </tr>
        `).join('');

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0">${tipo} | ${tLab} | ${cLab} Col</h2>
                <span class="summary-badge">Total: ${(data.totalSeg/3600).toFixed(1)} h</span>
            </div>
            <div class="chart-box"><canvas></canvas></div>
            <table>
                <thead>
                    <tr><th>Actividad</th><th>Min</th><th class="gold">Q1</th><th>Med</th><th>%</th><th>% Acum</th><th>CV%</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;

        setTimeout(() => {
            const ctx = card.querySelector('canvas').getContext('2d');
            charts.push(new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.items.slice(0,10).map(i => i.name),
                    datasets: [
                        { label: 'Segundos', data: data.items.slice(0,10).map(i => i.total), backgroundColor: color, yAxisID: 'y' },
                        { label: '% Acum', data: data.items.slice(0,10).map(i => i.acum), type: 'line', borderColor: '#f39c12', yAxisID: 'y1' }
                    ]
                },
                options: { indexAxis: 'x', maintainAspectRatio: false, scales: { y: { position: 'left' }, y1: { position: 'right', max: 100, grid: { display: false } } } }
            }));
        }, 50);

        return card;
    }

    document.getElementById('selTurno').addEventListener('change', updateUI);
    document.getElementById('selColor').addEventListener('change', updateUI);
</script>
</body>
</html>
