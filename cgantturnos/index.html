<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SMED crgm.app - Analizador Inteligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #1c1e21; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        
        /* UI de Carga y Archivo */
        .upload-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 800px; margin: auto; border: 2px solid #e0e0e0; }
        .drop-zone { border: 3px dashed var(--primary); padding: 40px; border-radius: 10px; background: #f8fbff; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { background: #eef6ff; }
        
        #status-box { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; font-weight: bold; }
        .status-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Estructura del Dashboard */
        .turno-header { background: var(--dark); color: white; padding: 20px; border-radius: 10px; margin: 50px 0 25px 0; font-size: 2em; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); border-top: 8px solid; }
        .border-INT { border-color: var(--primary); }
        .border-EXT { border-color: var(--success); }
        .border-NVA { border-color: var(--danger); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; text-transform: uppercase; color: #666; }
        td { padding: 10px; border: 1px solid #eee; text-align: center; }
        .gold { background: #fff9c4; font-weight: bold; color: #d4a017; border: 1px solid #f1c40f !important; }
        .sigma-badge { padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 10px; color: white; }
        
        .chart-container { height: 280px; position: relative; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="upload-card">
    <h1 style="margin-top:0; color:var(--dark)">SMED Advanced Analytics</h1>
    <p>Carga el CSV para analizar las 2 Corrugadoras y las 18 Imprentas</p>
    
    <div class="drop-zone" onclick="document.getElementById('csvFile').click()">
        <strong>Haga clic aquí para subir el archivo CSV</strong>
        <input type="file" id="csvFile" accept=".csv" style="display:none">
    </div>

    <div id="status-box"></div>
</div>

<div id="dashboard-container"></div>

<script>
    const csvInput = document.getElementById('csvFile');
    const statusBox = document.getElementById('status-box');
    const dashboard = document.getElementById('dashboard-container');

    csvInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        showStatus('Procesando datos y calculando Six Sigma...', 'loading');
        
        // Pequeño delay para dejar que el navegador muestre el mensaje de carga
        setTimeout(() => {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (validateColumns(results.data)) {
                        renderDashboard(results.data);
                        showStatus(`¡Éxito! Se cargaron ${results.data.length} registros correctamente.`, 'success');
                    } else {
                        showStatus('Error: El CSV no tiene las columnas necesarias (Turno, Tipo, Actividad, DuracionSeg).', 'error');
                    }
                },
                error: function(err) {
                    showStatus('Error al leer el archivo: ' + err, 'error');
                }
            });
        }, 100);
    });

    function showStatus(msg, type) {
        statusBox.innerText = msg;
        statusBox.className = 'status-' + type;
        statusBox.style.display = 'block';
    }

    function validateColumns(data) {
        if (!data || data.length === 0) return false;
        const keys = Object.keys(data[0]);
        return keys.includes('Turno') && keys.includes('Tipo') && keys.includes('DuracionSeg');
    }

    function renderDashboard(data) {
        dashboard.innerHTML = '';
        const tree = {};

        // Organizar datos
        data.forEach(row => {
            const { Turno, Tipo, Actividad, DuracionSeg } = row;
            if (!Turno || !Tipo || !Actividad) return;
            if (!tree[Turno]) tree[Turno] = {};
            if (!tree[Turno][Tipo]) tree[Turno][Tipo] = {};
            if (!tree[Turno][Tipo][Actividad]) tree[Turno][Tipo][Actividad] = [];
            tree[Turno][Tipo][Actividad].push(DuracionSeg);
        });

        const turnos = ['T1', 'T2', 'T3'];
        const tipos = ['INT', 'EXT', 'NVA'];
        const colors = { 'INT': '#007bff', 'EXT': '#28a745', 'NVA': '#dc3545' };

        turnos.forEach(t => {
            if (!tree[t]) return;

            const header = document.createElement('div');
            header.className = 'turno-header';
            header.innerText = `PANEL OPERATIVO: TURNO ${t}`;
            dashboard.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'grid';

            tipos.forEach(tipo => {
                if (!tree[t][tipo]) return;
                
                const stats = calculateAdvancedStats(tree[t][tipo]);
                const card = createDimensionCard(t, tipo, stats, colors[tipo]);
                grid.appendChild(card);
            });
            dashboard.appendChild(grid);
        });
    }

    function calculateAdvancedStats(activities) {
        return Object.keys(activities).map(name => {
            const vals = activities[name].filter(v => v != null).sort((a,b) => a - b);
            const n = vals.length;
            const sum = vals.reduce((a,b) => a + b, 0);
            const mean = sum / n;
            const std = Math.sqrt(vals.map(x => Math.pow(x - mean, 2)).reduce((a,b) => a + b, 0) / (n - 1)) || 0;
            
            return {
                name,
                total: sum,
                min: vals[0],
                q1: vals[Math.floor(n * 0.25)],
                med: vals[Math.floor(n * 0.5)],
                q3: vals[Math.floor(n * 0.75)],
                max: vals[n-1],
                cv: mean > 0 ? (std / mean) : 0
            };
        }).sort((a,b) => b.total - a.total).slice(0, 8);
    }

    function createDimensionCard(turno, tipo, stats, color) {
        const card = document.createElement('div');
        card.className = `card border-${tipo}`;
        const canvasId = `chart_${turno}_${tipo}`;

        let rows = stats.map(s => `
            <tr>
                <td style="text-align:left"><strong>${s.name}</strong></td>
                <td>${s.min}s</td>
                <td class="gold">${s.q1}s</td>
                <td>${s.med}s</td>
                <td>${s.max}s</td>
                <td><span class="sigma-badge" style="background:${s.cv < 0.5 ? '#28a745' : '#dc3545'}">${(s.cv * 100).toFixed(0)}%</span></td>
            </tr>
        `).join('');

        card.innerHTML = `
            <h2 style="margin-bottom:15px">${tipo === 'INT' ? 'INTERNAS' : tipo === 'EXT' ? 'EXTERNAS' : 'MUDAS (NVA)'}</h2>
            <div class="chart-container"><canvas id="${canvasId}"></canvas></div>
            <table>
                <thead>
                    <tr><th>Actividad</th><th>Min</th><th class="gold">Q1 (Meta)</th><th>Med</th><th>Max</th><th>Var%</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;

        setTimeout(() => {
            new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: stats.map(s => s.name),
                    datasets: [{ label: 'Segundos Totales', data: stats.map(s => s.total), backgroundColor: color, borderRadius: 5 }]
                },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }, 50);

        return card;
    }
</script>
</body>
</html>
